#!/usr/bin/env bash

GITZER_SOURCE="$(pwd)"

backend_folder="$GITZER_SOURCE/gitzer"
frontend_folder="$GITZER_SOURCE/gitzer-frontend"
rm -rf "build/"
mkdir "build/"
cd "$GITZER_SOURCE"
cd "$frontend_folder"
frontend_cache="$(realpath node_modules)"
frontend_cache="$(dirname $frontend_cache)"
rsync -a --progress "$frontend_folder/" "$frontend_cache" --exclude "node_modules" \
    --exclude "dist"
cd "$frontend_cache"
yarn && yarn generate
cd "$GITZER_SOURCE"
rsync -a --progress "$frontend_folder/dist/" "build/"

cd "$GITZER_SOURCE"
rsync -a --progress "$backend_folder/" "build/" \
    --exclude "tests" --exclude ".venv" \
    --exclude "poetry.lock" --exclude "**pycache**" \
    --exclude ".flake8" --exclude "db.sqlite3" \
    --exclude "pyproject.toml" --exclude "pytest.ini"
cd "build/"
python3 -m venv _vendor
source _vendor/bin/activate
pip3 install -r requirements.txt
cd "$GITZER_SOURCE"
cp "tools/main.py" "build/main.py"
cp "VERSION" "build/VERSION"

version=$(<VERSION)
tar cvfz "gitzer-$version.tar.gz" build/
